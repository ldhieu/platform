#!/usr/bin/env groovy

pipeline {

    options {
        skipDefaultCheckout true
    }

    agent {
        kubernetes {
            label 'jenkins-slave'
            containerTemplate {
                name 'mattermost-mysql'
                image 'mysql:5.7'
                containerPort 3306
                hostPost 3306
            }
            containerTemplate {
                name 'golang'
                image 'golang:1.8'
                ttyEnabled true
                command 'cat'
            }
        }
    }

    stages {
        stage('Checkout') {
            steps {
                // Checkout platform
                dir('platform') {
                    git branch: env.BRANCH_NAME, credentialsId: '5f3e0d1c-1c0e-4e88-8e53-80743eac981b', url: 'https://github.com/mattermost/platform.git'
                }

                dir('enterprise') {
                    script {
                        git branch: 'master', credentialsId: '5f3e0d1c-1c0e-4e88-8e53-80743eac981b', url: 'https://github.com/mattermost/enterprise.git'
                        sh "git checkout ${env.BRANCH_NAME} || echo 'NO EE BRANCH'"
                    }
                }


                sh 'mkdir -p /go/src/github.com/mattermost'
                sh 'ln -s `pwd`/platform /go/src/github.com/mattermost/platform'
                sh 'ln -s `pwd`/enterprise /go/src/github.com/mattermost/enterprise'
            }
        }
        stage('Build') {
            steps {
                // Building
                container('golang') {
                    sh 'cd /go/src/github.com/mattermost/platform && make build-linux'
                }
            }
        }

        stage('Unit Tests') {
            steps {
                container('golang') {
                    //sh 'cd /go/src/github.com/mattermost/platform && sed -i \'s/dockerhost/localhost/g\' config/config.json'
                    //sh 'cd /go/src/github.com/mattermost/platform && make test'
                }
            }
        }
    }
}
